<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Anchor Worm Detector</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; padding: 20px; }
        h1 { color: darkgreen; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        #preview { max-width: 300px; display: none; margin-top: 10px; }
        #result { font-size: 18px; margin-top: 20px; font-weight: bold; }
    </style>

    <!-- Roboflow InferenceJS -->
    <script src="https://cdn.jsdelivr.net/npm/inferencejs"></script>
</head>
<body>

    <h1>Anchor Worm Detector</h1>
    <p>Capture an image of the fish to check if itâ€™s healthy or affected.</p>

    <button onclick="startCamera()">ğŸ“· Open Camera</button>
    <button onclick="restart()">ğŸ” Restart</button>
    <br>

    <video id="camera" width="300" autoplay style="display:none;"></video>
    <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
    <br>
    <button id="captureBtn" onclick="capture()" style="display:none;">ğŸ“¸ Capture Image</button>

    <img id="preview" alt="Captured Image" />
    <p id="result">â³ Loading AI...</p>

    <script>
let video = document.getElementById('camera');
let canvas = document.getElementById('canvas');
let preview = document.getElementById('preview');
let captureBtn = document.getElementById('captureBtn');
let result = document.getElementById('result');
let stream;

let inferEngine;
let workerId;

// ===== Initialize Roboflow Inference =====
window.onload = async () => {
    try {
        const { InferenceEngine, CVImage } = inferencejs;
        inferEngine = new InferenceEngine();

        // your code exactly from the screenshot
        inferEngine
  .startWorker("my-first-project-kgrjk", "8", "rf_97jS1XP5e5fkkmqc8gR1rspyDkj1")
  .then(function(id) {
      workerId = id;
      result.innerHTML = "ğŸ¤– AI Ready! Capture image.";
      result.style.color = "green";
  })
  .catch(function(error) {
      result.innerHTML = "âŒ AI Load Failed! Check Console";
      result.style.color = "red";
      console.error("AI Load Error:", error);
  });
    } catch (err) {
        result.innerHTML = "âŒ Error loading AI";
        result.style.color = "red";
        console.error(err);
    }
};

// Start Rear Camera
function startCamera() {
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
    })
    .then(s => {
        stream = s;
        video.srcObject = stream;
        video.style.display = "block";
        captureBtn.style.display = "inline-block";
    })
    .catch(err => alert("Camera not accessible: " + err));
}

// Capture Image
function capture() {
    let ctx = canvas.getContext('2d');
    canvas.style.display = "block";
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    preview.src = canvas.toDataURL();
    preview.style.display = "block";
    detectWithAI();
}

// Roboflow Detection
async function detectWithAI() {
    if (!workerId) {
        result.innerHTML = "âš ï¸ AI still loading...";
        result.style.color = "orange";
        return;
    }

    result.innerHTML = "ğŸ” Detecting...";
    result.style.color = "blue";

    const { CVImage } = inferencejs;
    const image = new CVImage(preview);

    inferEngine.infer(workerId, image).then(predictions => {
        console.log(predictions);

        if (predictions.length > 0) {
            let best = predictions[0];
            if (best.confidence > 0.7) {
                result.innerHTML = "ğŸ”´ Anchor Worm Detected!";
                result.style.color = "red";
            } else {
                result.innerHTML = "ğŸŸ  Suspicious â€” Low Confidence!";
                result.style.color = "orange";
            }
        } else {
            result.innerHTML = "ğŸŸ¢ Fish appears healthy!";
            result.style.color = "green";
        }

        stopCamera();
    }).catch(err => {
        result.innerHTML = "âŒ Detection Failed!";
        result.style.color = "red";
        console.error(err);
    });
}

// Stop Camera
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.style.display = "none";
        captureBtn.style.display = "none";
    }
}

// Restart
function restart() {
    window.location.reload();
}
    </script>
</body>
</html>
