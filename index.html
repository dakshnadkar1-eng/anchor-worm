<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anchor Worm Identifier (Basic Module)</title>
    <!-- Load Tailwind CSS for simple styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better visual presentation and mobile focus */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 640px;
        }
        video, canvas {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="container bg-white p-6 rounded-xl shadow-2xl w-full">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Basic Fish Health Analyzer</h1>
        <p class="text-center text-gray-600 mb-6">
            Step 1: Allow camera access and point the camera at the affected area.
            <br>Step 2: Click 'Capture' to analyze.
        </p>

        <!-- Video Feed Area -->
        <div class="relative mb-4">
            <video id="cameraFeed" autoplay class="w-full bg-gray-200"></video>
            <!-- Overlay to simulate where analysis is focused -->
            <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden rounded-xl">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-t-indigo-500 border-gray-200"></div>
            </div>
        </div>

        <!-- Hidden Canvas for Image Processing -->
        <canvas id="imageCanvas" class="hidden"></canvas>

        <!-- Controls -->
        <div class="flex flex-col gap-3">
            <button id="captureButton"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md disabled:opacity-50"
                    disabled>
                Capture Image & Analyze
            </button>
            <button id="restartButton"
                    class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-sm"
                    onclick="window.location.reload()">
                Restart
            </button>
        </div>


        <!-- Result Display Area -->
        <div id="resultBox" class="mt-6 p-4 rounded-lg text-center font-bold text-xl transition-all duration-500 hidden">
            <!-- Results are injected here -->
        </div>

        <!-- Error/Message Box -->
        <div id="messageBox" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <!-- Messages are injected here -->
        </div>
    </div>

    <script>
        // --- Globals ---
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('imageCanvas');
        const context = canvas.getContext('2d');
        const captureButton = document.getElementById('captureButton');
        const resultBox = document.getElementById('resultBox');
        const messageBox = document.getElementById('messageBox');
        const loadingIndicator = document.getElementById('loadingIndicator');

        let stream = null;

        /**
         * Utility function to show messages/errors.
         * @param {string} message - The message to display.
         * @param {string} type - 'error' or 'info'.
         */
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = 'mt-4 p-3 rounded-lg block';
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
            }
            messageBox.classList.remove('hidden');
        }

        /**
         * Initializes the camera feed using the device's media stream API.
         */
        async function initCamera() {
            try {
                // Request access to the user's camera
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' } // Prefer the back camera for mobile
                });
                video.srcObject = stream;

                // Wait for the video to load metadata and start playing
                video.onloadedmetadata = () => {
                    video.play();
                    captureButton.disabled = false; // Enable button once camera is ready
                    showMessage('Camera is ready. Position the fish and capture.', 'info');
                    messageBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                    messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
                };

            } catch (err) {
                console.error("Error accessing camera: ", err);
                showMessage("Camera access failed. Please ensure your device has a camera and you've granted permission. Error: " + err.name, 'error');
                captureButton.disabled = true;
            }
        }

        /**
         * Captures a frame from the video stream onto the canvas and triggers analysis.
         */
        function captureImage() {
            if (!stream) {
                showMessage("Camera not started.", 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            resultBox.classList.add('hidden');
            captureButton.disabled = true;

            // Set canvas dimensions to match the video stream
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw the current video frame onto the canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Hide video feed and show the captured image (optional, but good for confirmation)
            video.style.display = 'none';
            canvas.style.display = 'block';

            // Stop the stream to free up the camera
            stream.getTracks().forEach(track => track.stop());

            // Run the basic analysis after a short delay to show 'loading'
            setTimeout(() => {
                const analysisResult = analyzeImage();
                displayResult(analysisResult);

                loadingIndicator.classList.add('hidden');
                captureButton.disabled = false;
            }, 1500); // Simulate a brief processing time
        }

        /**
         * * SIMULATED ANCHOR WORM IDENTIFICATION LOGIC *
         * This function performs a VERY basic, non-AI analysis (as requested to keep it simple).
         * It checks the pixel data in the center of the canvas.
         * The detection is purely random or based on a simple color threshold (e.g., checking for dark spots).
         * @returns {string} The analysis conclusion.
         */
        function analyzeImage() {
            // Get the entire image data from the canvas
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // 1. Check a small area in the center (e.g., a 10x10 pixel block)
            const centerX = Math.floor(canvas.width / 2);
            const centerY = Math.floor(canvas.height / 2);
            const checkRadius = 5; // Pixels around the center

            let totalBrightness = 0;
            let pixelCount = 0;

            for (let y = centerY - checkRadius; y < centerY + checkRadius; y++) {
                for (let x = centerX - checkRadius; x < centerX + checkRadius; x++) {
                    const index = (y * canvas.width + x) * 4;

                    // Skip if out of bounds (though unlikely with tight loop)
                    if (index < 0 || index >= data.length) continue;

                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];

                    // Calculate perceived brightness (luminance) using Luma formula (Y = 0.299R + 0.587G + 0.114B)
                    const brightness = (0.299 * r) + (0.587 * g) + (0.114 * b);
                    totalBrightness += brightness;
                    pixelCount++;
                }
            }

            const averageBrightness = totalBrightness / pixelCount;
            // Define a low brightness threshold (0-255 scale). Lower is darker.
            // If the area is very dark (simulating a foreign object like a worm), trigger "detection".
            const darkThreshold = 80;

            let isWormPresent = false;

            // In a basic module, we'll also add a 30% chance of random detection to simulate variability.
            if (averageBrightness < darkThreshold || Math.random() < 0.3) {
                isWormPresent = true;
            }

            // The user requested two specific phrases. We map the simulation result to these phrases:
            // WORM PRESENT (Needs attention) -> "No, it's absent"
            // WORM ABSENT (Perfect health) -> "Yes, it's perfect"
            if (isWormPresent) {
                return {
                    text: "No, it's absent", // User's requested phrase for "problem detected"
                    present: true
                };
            } else {
                return {
                    text: "Yes, it's perfect", // User's requested phrase for "no problem detected"
                    present: false
                };
            }
        }

        /**
         * Displays the final result to the user.
         * @param {{text: string, present: boolean}} result
         */
        function displayResult(result) {
            resultBox.textContent = result.text;
            resultBox.classList.remove('hidden');

            if (result.present) {
                // If worm is simulated as PRESENT ('No, it's absent'), use red/warning colors
                resultBox.classList.remove('bg-green-100', 'text-green-700');
                resultBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                // If worm is simulated as ABSENT ('Yes, it's perfect'), use green/success colors
                resultBox.classList.remove('bg-red-100', 'text-red-700');
                resultBox.classList.add('bg-green-100', 'text-green-700');
            }
            messageBox.classList.add('hidden'); // Hide info message
        }

        // --- Event Listeners and Initialization ---

        window.onload = initCamera;
        captureButton.addEventListener('click', captureImage);

    </script>
</body>
</html>
